---
title: "Data Analysis 2 Term Project"
author: "Gyongyver Kamenar (2103380)"
output: 
  pdf_document:
    extra_dependencies: ["float"]
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
#knitr::opts_chunk$set(fig.pos = "!H", out.extra = "")
# Set graph size
#knitr::opts_chunk$set(echo = FALSE, out.width = "50%" )#fig.asp = 0.5, fig.width = 7, out.width = "90%" )

rm(list=ls())

# Libraries

library(AER)
library(tidyverse)
library(lspline)
library(fixest)
library(modelsummary)
library(ggpubr)
library(reshape2)
library(kableExtra)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(corrplot)
library(scales)

# Get the data
# The data is too big to load from github but it can can be loaded from OSF datastore - It takes some time
#dt <-read.csv('https://osf.io/g72pq/download',encoding = "UTF-8")
# dt <-read.csv('https://media.githubusercontent.com/media/gyongyver-droid/ceu-data-analysis/master/Assignment3/data.csv?token=ANZLCU2736Q7PUXOAX4KFCTBX5GFE', encoding = "UTF-8")
# 
# data<-read.csv('https://github.com/gyongyver-droid/ceu-data-analysis/raw/master/Assignment3/data.csv',encoding = 'UTF-8')
df<-read.csv('clean_data.csv', encoding = "UTF-8")

```

## Introduction

This paper analyze the differneces in English correctness between English learners of several different native languages. 

HERE COMES THE MOTIVATION WHY THIS IS A MEANINGFUL PROJECT AND WHAT IS THE MAIN GOAL!


## Data

### Origin

The Massachusetts data are ...
Further information is available (here)[<https://www.rdocumentation.org/packages/AER/versions/1.2-9/topics/MASchools>].

### Variables
ECT.
```{r Data cleaning and mungling, message=FALSE, warning=FALSE, include=FALSE}
# Ckack the variables
summary(df)

## VARIABLES I WOULD DEFINITELY USE: 
# age, 
df %>%  group_by(age) %>% count() %>% arrange(age)
# gender, 
df %>%  group_by(gender) %>% count() %>% arrange(desc(n))
# natlangs/nat_eng, 
df %>%  group_by(natlangs) %>% count() %>% arrange(desc(n))
df %>%  group_by(nat_Eng) %>% count() %>% arrange(desc(n))
# primelangs/prime_eng, 
df %>%  group_by(primelangs) %>% count() %>% arrange(desc(n))
df %>%  group_by(prime_Eng) %>% count() %>% arrange(desc(n))
# psychiatric
df %>%  group_by(psychiatric) %>% count() %>% arrange(desc(n))
# highest level of education
df %>%  group_by(education) %>% count() %>% arrange(desc(n))
# Eng_start
df %>%  group_by(Eng_start) %>% count() %>% arrange(desc(n))
# Eng_little
df %>%  group_by(Eng_little) %>% count() %>% arrange(desc(n))
# correct / elogit
df %>%  group_by(correct) %>% count() %>% arrange(desc(n))

## Set base categories

df <-df %>% mutate(
  age = as.numeric(age),
  Eng_start = as.numeric(Eng_start),
  prime_Eng = as.numeric(prime_Eng),
  education=as.factor(education),
  natlangs = as.factor(natlangs),
  Eng_little = as.factor(Eng_little),
  learning = age - Eng_start,
  education = relevel(education,ref = "Haven't Finished High School (less than 13 years ed)"),
  natlangs = relevel(natlangs, ref = "English"),
  Eng_little = relevel(Eng_little,ref = "monoeng")
  
)

foreign<-filter(df,df$nat_Eng==0)

```


```{r Descriptive statistics, echo=FALSE, message=FALSE, warning=FALSE}
# Sample selection
df<- df %>% select( age, gender, education, learning,
                     Eng_start, natlangs, nat_Eng, primelangs, prime_Eng,
                     psychiatric , correct, elogit, Eng_little ) %>% drop_na()

P95 <- function(x){quantile(x,0.95,na.rm=T)}
P05 <- function(x){quantile(x,0.05,na.rm=T)}
datasummary( (`Age` = age ) +  
             (`Age at start of English learning` = Eng_start ) + 
             (`Psychiatric disorder` = psychiatric) + 
             (`Critical items correct (%)` = correct) +
               (`Years of English learning` = learning) +
             (`Log(correct)` = elogit)  ~
             Mean + Median + SD + Min + Max + P05 + P95 , 
             data = df ,
             title = 'Descriptive statistics') %>% 
      kable_styling(latex_options = c("HOLD_position","scale_down"), font_size = 11)
```

The number of observations is `r sum(!is.na(df$score4))` for all of our key variables.

DESCRIPTION OF THE SUMMARY STATS: WHAT CAN WE LEARN FROM THEM?

As the focus is the price difference, the next Figure shows the histogram for this variable.

```{r My theme, message=FALSE, warning=FALSE, include=FALSE}
theme_gyongyver<-function(base_size=11){
  # Use the basic properties of theme_bw
  theme_light() %+replace% 
    
    # Change the items
    theme(
      # The grids on the background
      panel.grid.major  = element_line(color = "slategray2"),
      panel.grid.minor = element_line(color="grey90"),
      # The background color
      panel.background  = element_rect(fill = "grey95"),
      # the axis line
      axis.line         = element_line(color = "navyblue"),
      # Littel lines called ticks on the axis
      axis.ticks        = element_line(color = "navy"),
      # Numbers on the axis
      axis.text         = element_text(color = "navy"),
      # NEW ONES
      # rectangle element
      rect = element_rect(fill="grey10",colour = "white"),
      # axis title
      axis.title = element_text(colour="mediumblue"),
      # plot background
      plot.background = element_rect(fill="white"),
      # title
      plot.title = element_text(family = "", colour="midnightblue", size=12, hjust = 0, vjust=0.8),
      plot.subtitle = element_text(family = "", colour="midnightblue", size=10, hjust = 0),
      #caption
      plot.caption = element_text(size = 9, colour = "steelblue3", hjust = 1),
      #legend
      legend.background = element_rect(fill = "grey80", colour = "grey90"),
      legend.text = element_text(colour = "black"),
      panel.border = element_blank()
      
    )
  
}

```


```{r EDA, echo=FALSE, fig.align="center", warning=FALSE}
# correct
p1 <- ggplot( df , aes(x = correct)) +
  geom_histogram(  fill='navyblue', color = 'white' ) +
  labs(
    title = "Distribution of English correctness",
    y = 'Count',
    x = "Correct English test items (%)") +
  theme_gyongyver()+
  scale_x_continuous(limits = c(0.65,1),labels = scales::percent)+
  scale_y_continuous(labels = label_number(suffix = " K", scale = 1e-3))

# logit of correct
p2 <- ggplot( df , aes(x = elogit)) +
  geom_histogram(  fill='navyblue', color = 'white' ) +
  labs(
    title = "Distribution of Log of English correctness",
    y = 'Count',
    x = "Log(Correct English test items%)") +
  theme_gyongyver()+
  scale_x_continuous(limits = c(0,6),breaks=seq(0,6,0.5))+
  scale_y_continuous(labels = label_number(suffix = " K", scale = 1e-3))

# age
p3 <- ggplot( df , aes(x = age)) +
  geom_histogram(  fill='navyblue', color = 'white' ) +
  labs(
    title = "Distribution of age",
    y = 'Count',
    x = "Age") +
  theme_gyongyver()+
  scale_x_continuous(limits = c(10,75),breaks=seq(10,75,10))+
  scale_y_continuous(labels = label_number(suffix = " K", scale = 1e-3))

# age at start of English learning
p4 <- ggplot( df , aes(x = Eng_start)) +
  geom_histogram( fill='navyblue', color = 'white', bins = 12 ) +
  labs(
    title = "Distribution of age at start of English learning",
    y = 'Count',
    x = "Age at start of English learning") +
  theme_gyongyver()+
  scale_x_continuous(limits = c(-5,30))+
  scale_y_continuous(labels = label_number(suffix = " K", scale = 1e-3))



distribution_figs <- ggarrange(p1, p2,p3, p4,
                       hjust = -0.3,
                       ncol = 2, nrow = 2)
distribution_figs

# frequency of native languages
df %>%  group_by(natlangs) %>% count() %>% arrange(desc(n)) %>% 
  ggplot(aes(x=natlangs, y=n))+
  geom_bar(stat='identity', fill="navyblue")+
  geom_text(aes(label=n), vjust=-0.3, size=4) +
  theme_gyongyver()+
  labs(
    title = "Frequency of native languages",
    x="",
    y=""
  )+
  scale_y_continuous(labels = label_number(suffix = " K", scale = 1e-3))+
  theme(axis.text.x = element_text(size = 9))


plot(df$natlangs, df$correct)
```

DESCRIPTION OF THE FIGURE. WHAT DOES IT TELS US?

(May change the order of descriptive stats and graph.)

The key pattern of association is:

```{r Patterns of association, echo=FALSE, message=FALSE, warning=FALSE}

# Scatterplots
f1<-ggplot(df, aes(x=Eng_start, y=correct))+
  geom_point( alpha=0.05, color="navyblue")+
  geom_smooth(method = "gam", color="red")+
  facet_wrap(~natlangs, ncol = 4)+
  theme_gyongyver()+
  labs(
    title = "Pattern of starting age of English learning",
    x = "Starting age of English learning",
    y= "English correctness"
  )
  
f1  

f2<-ggplot(df, aes(x=age, y=correct))+
  geom_point( alpha=0.05, color="navyblue")+
  geom_smooth(method = "gam", color="red")+
  facet_wrap(~natlangs, ncol = 4)+
  theme_gyongyver()+
  labs(
    title = "Pattern of age in English correctness",
    x = "Age",
    y= "English correctness"
  )
f2


# Smooth
filter(df, df$natlangs=="Dutch") %>% 
ggplot()+
  geom_smooth(aes(x=Eng_start, y=correct), color="red", method = "gam")+
  geom_point(aes(x=Eng_start, y=correct), alpha= 0.2, color="navyblue")+
  theme_gyongyver()
  
```

```{r Smoothed plots, echo=FALSE, message=FALSE, warning=FALSE}
f2
f1

# Correlation matrix
matrix<-cor(df[,c(1,4,6,8,9,10,11,13)])
colnames(matrix)<-c("Age", "English starting age","Native English","Primary English", "Psychiatric", "English correctness",
                    "Log of English correctness","Years of English learning")
rownames(matrix)<-c("Age", "English starting age","Native English","Primary English", "Psychiatric", "English correctness",
                    "Log of English correctness","Years of English learning")

corrplot(matrix,addCoef.col = 'grey50',tl.col = "black",
         tl.cex = 0.9, tl.srt=45,number.cex=0.8, number.digits=2)

```


```{r Binscatter, echo=FALSE, message=FALSE, warning=FALSE}

StatBinscatter <- ggplot2::ggproto(
  "StatBinscatter", 
  Stat,
  compute_group = function(data, scales, bins = 10) {
    bins     <- min(floor(nrow(data)/10), bins)
    x_bin    <- ggplot2::cut_number(data$x + 1e-12*runif(nrow(data)), bins)
    x_means  <- stats::ave(data$x, x_bin, FUN = mean)
    y_means  <- stats::ave(data$y, x_bin, FUN = mean)
    y_se     <- stats::ave(data$y, x_bin, FUN = sd)
    y_obs    <- stats::ave(data$y, x_bin, FUN = length)
    result   <- data.frame(x    = x_means, 
                           y    = y_means, 
                           ymax = y_means + 1.96*y_se/sqrt(y_obs),
                           ymin = y_means - 1.96*y_se/sqrt(y_obs))
    result   <- unique(result)
    return(result)
  },
  required_aes = c("x", "y")
)

stat_binscatter <- function(mapping = NULL, data = NULL, geom = "point",
                            position = "identity", na.rm = FALSE, show.legend = NA, 
                            inherit.aes = TRUE, ...) {
  ggplot2::layer(
    stat = StatBinscatter, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
    )
}

ggplot(df, aes(x=Eng_start, y=elogit))+
  geom_point(alpha=.01, color="navyblue")+
  stat_binscatter(color="red",bins=30,geom = "pointrange")+
  theme_gyongyver()
  
```

How will you include this in your model?

Short description on the other variables: 2-10 sentence depends on the amount of variables you have. You should reference your decisions on the graphs/analysis which are located in the appendix.

## Models


```{r Models, message=FALSE, warning=FALSE, include=FALSE}

# reg1: NO control, simple linear regression
reg1 <- feols( correct ~ natlangs, data = df , vcov = 'hetero' )
summary(reg1)

# reg2: With controls
reg2<- feols( correct ~ age + gender + natlangs+ education +psychiatric+Eng_start , data = df , vcov = 'hetero' )
summary(reg2)

# reg3: additional control for starting age of English learning
#   Is your parameter different? Is it a confounder?

reg3 <-feols( correct ~ gender + natlangs+ education +psychiatric +learning +Eng_start , data = df , vcov = 'hetero' )
summary(reg3)
##
# reg4: reg3 + slines of starting age of English learning
reg4 <- feols( correct ~ age + gender + natlangs+ education + psychiatric +lspline(Eng_start,2) , data = df , vcov = 'hetero' )
summary(reg4)
#
# reg5: reg4 + salary with P.L.S, knots at 35 and 40, exptot, log of income and scratio
reg5 <- feols( correct ~ age + gender + natlangs+ education + psychiatric +lspline(Eng_start,1) ,
               data = df , vcov = 'hetero' )


etable(reg1,reg2,reg3,reg4,reg5)

# Test difference
library(car)
linearHypothesis(reg5, "natlangsPolish - natlangsHungarian = 0")
linearHypothesis(reg5, "age - Eng_start = 0")
linearHypothesis(reg4,"lspline(Eng_start, 2)1 - lspline(Eng_start, 2)2 = 0")
linearHypothesis(reg5, "gendermale - genderother = 0")
# Naming the coefficients for pretty output
alpha  <- round( reg5$coeftable[1,1] , 2 )
b1 <- round( reg5$coeftable[2,1] , 2 )
b2 <- round( reg5$coeftable[3,1] , 2 )

```

My preferred model is:

score = $`r alpha`$ $`r b1`$ $( student/teacher < 18)$ $`r b2`$ $( student/teacher \geq 18) + \delta Z$

where $Z$ are standing for the controls, which includes controlling for english language, lunch, other special characteristics and wealth measures. From this model we can infer:

- when every covariates are zero, students expected to have grade score of $`r alpha`$
- when the student to teacher is one unit larger, but below the value of 18, we see students to have on average $`r abs(b1)`$ smaller grades.
- when the student to teacher is one unit larger, with the value above or equal to 18, we see students to have on average $`r abs(b2)`$ smaller grades.

However, based on the heteroskedastic robust standard errors, these results are statistically non different from zero. To show that, I have run a two-sided hypothesis test:
$$H_0:=\beta_1 = 0$$
$$H_A:=\beta_1 \neq 0$$
I have the t-statistic as `r round( reg5$coeftable[2,3] , 2 )` and the p-value as `r round( reg5$coeftable[2,4] , 2 )`, which confirms my conclusion.

We compare multiple models to learn about the stability of the parameters. Bla-bla:

```{r Regtable, echo=FALSE, message=FALSE, warning=FALSE}
##
# Summarize our findings:
varname_report <- c("(Intercept)" = "Intercept",
                   "nalangsDutch" = "Native Dutch",
                   "nalangsFinnish" = "Native Finnish",
                   "nalangsGerman" = "Native German",
                   "nalangsHungarian" = "Native Hungarian",
                   "nalangsPolish" = "Native Polish",
                   "nalangsRussian" = "Native Russian",
                   "nalangsSpanish" = "Native Spanish",
                   "nalangsSwedish" = "Native Swedish",
                   "nalangsTurkish" = "Native Turkish",
                   "lspline(Eng_start,2)1" = "Starting age of English learning (<2)",
                   "lspline(Eng_start,2)2" = "Starting age of English learning (>=2)",
                   "age" = "Age",
                   "gendermale" = "Male",
                   "genderother" = "Other gender",
                   "educationHighSchoolDegree(12-13years)" = "HighSchool Degree (12-13years ed)",
                   "educationSomeUndergrad(highered)" = "Some Undergrad (highered)",
                   "educationUndergraduateDegree(3-5yearshighered)" = "Undergraduate Degree (3-5years highered)",
                   "educationSomeGraduateSchool" = "Some Graduate School",
                   "educationGraduateDegree" = "Graduate Degree",
                   "Eng_start" = "Starting age of English learning"
                   
                   )


# Note: coefstat = 'confint' is just an example, usually you need to report se.
style_noHeaders = style.tex(var.title = "", fixef.title = "", stats.title = " ")


# kable( etable( reg1 , reg2 , reg3 , reg4 , reg5 ,
#         title = 'Average test scores for 4th graders',
#         dict = varname_report,
#         drop = vars_omit ,
#         group = groupConf ,
#         se.below = T,
#         coefstat = 'se',
#         fitstat = c('n','r2'),
#         se.row = F,
#         depvar = F ) , 
#         col.names = c('(1)','(2)','(3)','(4)','(5)'),
#        "latex", booktabs = TRUE,  position = "H",
#        caption = 'Models to uncover relation between test score and student to teacher ratio') %>% kable_styling(latex_options = c("hold_position","scale_down"))

msummary(list("Simple"=reg1, "Multiple"=reg2,"Multiple with starting age"=reg3,
              "Splines"=reg4,"Splines"=reg5),
         title = "Estimated models",
         fmt="%.3f",
         statistic = "std.error",
         gof_omit = 'DF|Deviance|F|R2 Adj.|AIC|PseudoR2',
         stars=c('**' = .05, '***' = .01),
         coef_rename = varname_report,
         notes = ''
) %>% kable_styling(latex_options = c("HOLD_position","scale_down"),
                    font_size = 11)


```





## Robustness check / 'Heterogeneity analysis'

Task: calculate and report t-tests for each countries. 



## Conclusion

HERE COMES WHAT WE HAVE LEARNED AND WHAT WOULD STRENGHTEN AND WEAKEN OUR ANALYSIS.

\newpage 
## Appendix

Here comes all the results which are referenced and not essential for understanding the MAIN results.
